<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Processador de Laudos</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f8f9fa;
            --card-bg: #fff;
            --text-color: #2c3e50;
            --primary-color: #007bff;
            --primary-hover: #2980b9;
            --secondary-color: #95a5a6;
            --secondary-hover: #7f8c8d;
            --border-color: #e0e6ed;
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        html.dark-mode {
            --bg-color: #2c3e50;
            --card-bg: #34495e;
            --text-color: #ecf0f1;
            --primary-color: #0d6efd;
            --primary-hover: #5dade2;
            --secondary-color: #7f8c8d;
            --secondary-hover: #95a5a6;
            --border-color: #4a6572;
        }
        * {
            box-sizing: border-box; /* Garante que padding não aumente a largura total */
        }
        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 24px;
            transition: background-color 0.3s, color 0.3s;
        }
        .page-wrapper {
            display: flex;
            gap: 24px;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
        }
        .container {
            background-color: var(--card-bg);
            border-radius: 12px;
            box-shadow: var(--box-shadow);
            padding: 24px 32px;
            width: 100%;
            flex: 3; /* Ocupa 3 partes do espaço */
            transition: background-color 0.3s;
        }
        .sidebar {
            background-color: var(--card-bg);
            border-radius: 12px;
            box-shadow: var(--box-shadow);
            padding: 24px;
            width: 100%;
            flex: 1; /* Ocupa 1 parte do espaço */
            align-self: flex-start; /* Alinha ao topo */
        }
        .sidebar h2 {
            margin-top: 0;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }
        #lista-exames {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 400px;
            overflow-y: auto;
        }
        #lista-exames li {
            padding: 8px 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        #lista-exames li:not(:last-child) {
            border-bottom: 1px solid var(--border-color);
        }
        #lista-exames input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }
        #lista-exames .valor-alterado {
            color: #e74c3c; /* Vermelho para alerta */
            font-weight: 700;
        }
        #lista-exames .valor-alterado::before {
            content: '⚠️ ';
        }
        #lista-exames .novo-exame-tag {
            background-color: var(--primary-color);
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 700;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 16px;
            margin-bottom: 24px;
        }
        h1 {
            font-size: 24px;
            font-weight: 700;
            margin: 0;
            color: var(--text-color);
        }
        p { line-height: 1.6; }
        textarea {
            width: 100%;
            min-height: 250px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 14px;
            resize: vertical;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        .actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            flex-grow: 1;
        }
        button:active { transform: scale(0.98); }
        .btn-primary {
            background: linear-gradient(45deg, var(--primary-color), var(--primary-hover));
            color: white;
        }
        .btn-primary:hover { background-color: var(--primary-hover); }
        .btn-secondary {
            background-color: transparent;
            color: var(--secondary-hover);
            border: 1px solid var(--border-color);
        }
        .btn-secondary:hover { background-color: var(--bg-color); }
        #resultado {
            /* ... (estilos existentes) ... */
        }
        .resultado-wrapper {
            position: relative;
            margin-top: 16px;
        }
        #resultado {
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
            font-family: 'Courier New', Courier, monospace;
            font-weight: 500;
            line-height: 1.5;
            min-height: 40px;
            word-wrap: break-word;
            transition: background-color 0.3s, border-color 0.3s;
        }
        .copy-btn-individual {
            background: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 4px 8px;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s, background-color 0.2s;
            font-size: 12px;
            flex-shrink: 0; /* Impede que o botão encolha */
        }
        .copy-btn-individual:hover {
            opacity: 1;
            background-color: var(--primary-color);
        }
        #recentes-container {
            margin-top: 32px;
            border-top: 1px solid var(--border-color);
            padding-top: 16px;
        }
        .header-recentes {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        #btn-limpar-historico {
            background: transparent;
            border: none;
            color: var(--secondary-hover);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .accordion-item {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 8px;
            overflow: hidden;
        }
        .accordion-header {
            background-color: var(--bg-color);
            padding: 12px 16px;
            cursor: pointer;
            font-weight: 700;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .accordion-header:hover { filter: brightness(95%); }
        .accordion-content {
            padding: 8px 16px;
            display: none; /* Escondido por padrão */
        }
        .resultado-recente-item {
            font-size: 14px;
            font-family: 'Courier New', Courier, monospace;
            font-weight: 500; /* Deixa a fonte mais forte */
            padding: 8px 0;
            border-bottom: 1px dashed var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
        }
        .accordion-content .resultado-recente-item:last-child {
            border-bottom: none;
        }
        .instructions {
            font-size: 14px;
            color: var(--secondary-hover);
        }
        .theme-switch-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--secondary-hover);
        }
        .theme-switch {
            display: inline-block;
            height: 24px;
            position: relative;
            width: 48px;
        }
        .theme-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            background-color: #ccc;
            bottom: 0;
            cursor: pointer;
            left: 0;
            position: absolute;
            right: 0;
            top: 0;
            transition: .4s;
        }
        .slider:before {
            background-color: white;
            bottom: 3px;
            content: "";
            height: 18px;
            left: 4px;
            position: absolute;
            transition: .4s;
            width: 18px;
        }
        input:checked + .slider {
            background-color: var(--primary-color);
        }
        input:checked + .slider:before {
            transform: translateX(22px);
        }
        .slider.round {
            border-radius: 24px;
        }
        .slider.round:before {
            border-radius: 50%;
        }
        /* Estilo para a notificação Toast */
        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #34495e; /* Fundo escuro no modo claro */
            color: #ecf0f1;
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            z-index: 10;
            left: 50%;
            transform: translateX(-50%);
            bottom: 30px;
            opacity: 0;
            transition: opacity 0.5s, bottom 0.5s, visibility 0.5s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        #toast.show {
            visibility: visible;
            opacity: 1;
            bottom: 50px; /* Efeito de deslizar para cima */
        }
        html.dark-mode #toast {
            background-color: #ecf0f1; /* Fundo claro no modo escuro */
            color: #34495e;
        }
    </style>
</head>
<body>
    <div class="page-wrapper">
        <div class="container">
            <div class="header">
                <h1>Processador de Laudos</h1>
                <div class="theme-switch-wrapper">
                    <span>Modo Escuro</span>
                    <label class="theme-switch" for="theme-toggle" title="Alternar tema">
                        <input type="checkbox" id="theme-toggle" />
                        <div class="slider round"></div>
                    </label>
                </div>
            </div>
            <div class="instructions">
                <p><strong>Como usar:</strong><br>
                1. Copie o conteúdo do laudo (<strong>CTRL+C</strong>).<br>
                2. Cole na caixa abaixo e clique em <strong>Analisar Laudo</strong> para ver os exames na barra lateral.</p>
            </div>
            <textarea id="input" placeholder="Aguardando dados do laudo..."></textarea>
            <div class="actions">
                <button onclick="processar()" class="btn-primary">Analisar Laudo</button>
                <button onclick="copiarResultado()" class="btn-secondary">Copiar Resultado</button>
                <button onclick="limparTudo()" class="btn-secondary">Limpar Campos</button>
            </div>
            <div class="resultado-wrapper">
                <p><strong>Resultado Final:</strong></p>
                <div id="resultado"></div>
            </div>
    
            <div id="recentes-container">
                <div class="header-recentes">
                    <h2>Resultados Recentes</h2>
                    <button id="btn-limpar-historico" onclick="limparHistorico()">Limpar Histórico</button>
                </div>
                <div id="lista-recentes"></div>
            </div>
    
            <!-- Elemento da notificação Toast -->
            <div id="toast"></div>
        </div>

        <div class="sidebar">
            <h2>Exames Encontrados</h2>
            <ul id="lista-exames">
                <li class="instructions">Analise um laudo para ver os exames aqui.</li>
            </ul>
        </div>
    </div>

  <script>
    const themeToggle = document.getElementById('theme-toggle');
    const resultadoDiv = document.getElementById('resultado');

    // Verifica o tema salvo no localStorage quando a página carrega
    if (localStorage.getItem('darkMode') === 'enabled') {
        document.documentElement.classList.add('dark-mode');
        themeToggle.checked = true;
    }

    themeToggle.addEventListener('change', () => {
        document.documentElement.classList.toggle('dark-mode');
        // Salva a preferência no localStorage
        if (document.documentElement.classList.contains('dark-mode')) {
            localStorage.setItem('darkMode', 'enabled');
        } else {
            localStorage.setItem('darkMode', 'disabled');
        }
    });

    let toastTimeout; // Variável para controlar o timeout do toast

    function showToast(message) {
        const toast = document.getElementById("toast");
        toast.innerText = message;
        toast.classList.add("show");

        // Limpa o timeout anterior se houver um
        clearTimeout(toastTimeout);

        // Esconde o toast após 3 segundos
        toastTimeout = setTimeout(() => {
            toast.classList.remove("show");
        }, 3000);
    }

    function copiarResultado() {
        const textoResultado = resultadoDiv.innerText;
        if (textoResultado) {
            navigator.clipboard.writeText(textoResultado)
                .then(() => showToast('Resultado copiado!'))
                .catch(() => showToast('Falha ao copiar.'));
        } else {
            showToast('Nada para copiar.');
        }
    }

    function limparTudo() {
        document.getElementById('input').value = '';
        document.getElementById('lista-exames').innerHTML = '<li class="instructions">Analise um laudo para ver os exames aqui.</li>';
        resultadoDiv.innerText = '';
    }

    function limparHistorico() {
        if (confirm('Tem certeza que deseja apagar todo o histórico de resultados? Esta ação não pode ser desfeita.')) {
            localStorage.removeItem('resultadosRecentes');
            renderizarResultadosRecentes();
            showToast('Histórico limpo com sucesso!');
        }
    }

    function renderizarResultadosRecentes() {
        const listaRecentesDiv = document.getElementById('lista-recentes');
        const resultados = JSON.parse(localStorage.getItem('resultadosRecentes') || '[]');
        
        if (resultados.length === 0) {
            listaRecentesDiv.innerHTML = '<p class="instructions">Nenhum resultado processado ainda.</p>';
            return;
        }

        // Agrupa resultados por paciente
        const agrupados = resultados.reduce((acc, res) => {
            acc[res.paciente] = acc[res.paciente] || [];
            acc[res.paciente].push(res);
            return acc;
        }, {});

        let html = '';
        // Ordena pacientes pelo mais recente
        const pacientesOrdenados = Object.keys(agrupados).sort((a, b) => {
            const dataA = Math.max(...agrupados[a].map(r => r.id));
            const dataB = Math.max(...agrupados[b].map(r => r.id));
            return dataB - dataA;
        });

        for (const paciente of pacientesOrdenados) {
            html += `<div class="accordion-item">`;
            html += `<div class="accordion-header" onclick="toggleAccordion(this)"><span>${paciente}</span><span>▼</span></div>`;
            html += `<div class="accordion-content">`;

            // Ordena resultados do paciente por data (mais novo primeiro)
            agrupados[paciente].sort((a, b) => new Date(b.dataCompleta) - new Date(a.dataCompleta));

            for (const res of agrupados[paciente]) {
                // Escapa aspas simples no resultado para não quebrar o JS no onclick
                const resultadoEscapado = res.resultado.replace(/'/g, "\\'");
                html += `<div class="resultado-recente-item">
                            <span>${res.resultado}</span>
                            <button class="copy-btn-individual" title="Copiar este resultado" onclick="copiarTexto('${resultadoEscapado}')">Copiar</button>
                         </div>`;
            }
            html += `</div></div>`;
        }

        listaRecentesDiv.innerHTML = html;
    }

    function toggleAccordion(element) {
        const content = element.nextElementSibling;
        content.style.display = content.style.display === 'block' ? 'none' : 'block';
        const icon = element.querySelector('span:last-child');
        icon.textContent = content.style.display === 'block' ? '▲' : '▼';
    }

    // Renderiza os resultados recentes ao carregar a página
    document.addEventListener('DOMContentLoaded', renderizarResultadosRecentes);

    // Variável global para armazenar os exames encontrados na última análise
    let examesEncontradosGlobal = [];
    const LABELS_EXAMES = ["Hemograma Completo", "Eritrócitos", "Hemoglobina", "Hematocrito", "Plaquetas", "Leucocitos", "Neutrofilos", "Tempo e atividade Protrombina", "RNI", "TTPA - Tempo de Tromboplastina Parcial Ativada", "Relacao paciente/normal", "Gasometria Arterial", "Gasometria Venosa", "Ureia, sérica", "Ureia", "Dosagem sérica de Creatinina", "Creatinina", "Sódio", "Potássio", "Magnésio", "Bilirrubinas", "Bilirrubina Total", "Bilirrubina Direta", "Bilirrubina Indireta", "TGO/AST", "TGP/ALT", "Gama Glutamil Transferase - GGT", "Fosfatase Alcalina", "Lactato Arterial", "Proteína C Reativa - PCR", "Calcio Ionizado", "PH", "Saturacao de O2", "Bicarbonato", "Base Exces"];

    function removerAcentos(str) {
        return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    }

    // Pega data mais proxima no texto
    function pegarData(texto) {
        const m = texto.match(/Coleta:\s*([\d\/]{8,10})/i);
        return m ? m[1].replace(/\/\d{4}$/, '') : null;
    }
    // Pega o nome do paciente
    function pegarNomePaciente(texto) {
        const m = texto.match(/Paciente:\s*([^\n]+)/i);
        return m ? m[1].trim() : "Paciente Desconhecido";
    }
    // Pega a data completa para ordenação
    function pegarDataCompleta(texto) {
        const m = texto.match(/Coleta:\s*([\d\/]{8,10})/i);
        if (!m) return null;
        const [dia, mes, ano] = m[1].split('/');
        return `${ano}-${mes}-${dia}`; // Formato YYYY-MM-DD para fácil ordenação
    }

    function analisarExame(label, texto, labelAlternativo = null) {
        // Cria uma regex que ignora acentos para encontrar o label
        const todosOsLabels = LABELS_EXAMES.map(l => removerAcentos(l).replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')).join('|');
        const textoSemAcentos = removerAcentos(texto);
        
        let labelDeBusca = label;
        let re = new RegExp(`(${removerAcentos(label).replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')}[\\s\\S]*?)(?=\\n(?:${todosOsLabels})|\\n^Liberado por|$)`, "i");
        let blocoExame = textoSemAcentos.match(re);

        if ((!blocoExame || !blocoExame[0]) && labelAlternativo) {
            labelDeBusca = labelAlternativo;
            re = new RegExp(`(${removerAcentos(labelAlternativo).replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')}[\\s\\S]*?)(?=\\n(?:${todosOsLabels})|\\n^Liberado por|$)`, "i");
            blocoExame = textoSemAcentos.match(re);
        }

        if (!blocoExame || !blocoExame[0]) { 
            return { valor: null, status: 'nao_encontrado' }; 
        }

        const textoBloco = blocoExame[0];

        let valorMatch;
        // Estratégia 1: Procurar o valor após a palavra "Resultado". É mais confiável.
        const resultadoRegex = /Resultado\s*([\d,.-]+)/i;
        valorMatch = textoBloco.match(resultadoRegex);

        // Estratégia 2 (Fallback): Se não achar "Resultado", procura o primeiro número em uma nova linha após o label.
        if (!valorMatch) {
            const labelSemAcentos = removerAcentos(labelDeBusca).replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
            const fallbackRegex = new RegExp(`${labelSemAcentos}[\\s\\S]*?\\n\\s*([\\d,.-]+(?![:/]))`, "i");
            valorMatch = textoBloco.match(fallbackRegex);
        }

        // Caso especial para Neutrófilos: tenta pegar o segundo valor (absoluto) se houver dois.
        if (label.toLowerCase().includes("neutrofilos")) {
            const neutrofilosRegex = /[\\d,.-]+\\s*\\n+\\s*([\\d,.-]+)/i; // Procura o segundo número em uma nova linha
            const neutrofilosMatch = textoBloco.match(neutrofilosRegex);
            if (neutrofilosMatch && neutrofilosMatch[1]) valorMatch = neutrofilosMatch; // Sobrescreve o valor encontrado se o segundo valor existir
        }

        if (!valorMatch || !valorMatch[1]) { 
            return { valor: null, status: 'nao_encontrado' }; 
        }

        const valorStr = valorMatch[1].replace(',', '.');
        const valorNum = parseFloat(valorStr);

        // Lógica para verificar se está alterado (mantida)
        const refMatch = textoBloco.match(/(\d+[,.]\d+)\s*(?:a|ate|até|-)\s*(\d+[,.]\d+)/i);
        const refInferior = textoBloco.match(/(?:Inferior a|Menor que)\s*(\d+[,.]\d+)/i);

        let status = 'normal';
        if (refMatch) {
            const min = parseFloat(refMatch[1].replace(',', '.'));
            const max = parseFloat(refMatch[2].replace(',', '.'));
            if (valorNum < min || valorNum > max) status = 'alterado';
        } else if (refInferior) {
            const max = parseFloat(refInferior[1].replace(',', '.'));
            if (valorNum > max) status = 'alterado';
        }

        return { valor: valorStr, status: status };
    }

  function processar() {
  const texto = document.getElementById("input").value;
  if (!texto.trim()) {
      showToast("A área de texto está vazia.");
      return;
  }

  // Separa os blocos de gasometria para análise individual
  const blocoGasometriaArterial = (texto.match(/Gasometria Arterial([\s\S]*?)(?=Gasometria Venosa|Liberado por|$)/i) || [])[0] || "";
  const blocoGasometriaVenosa = (texto.match(/Gasometria Venosa([\s\S]*?)(?=Gasometria Arterial|Liberado por|$)/i) || [])[0] || "";
  // Se não encontrar blocos específicos, usa o texto todo para retrocompatibilidade
  const textoArterial = blocoGasometriaArterial || texto;

  // --- LÓGICA DE ANÁLISE ---
  // Estrutura de configuração para todos os exames conhecidos
  const configExames = [
      { id: 'data', label: 'Data', value: pegarData(texto), selected: true, template: (v) => `${v}: ` },
      { id: 'hb', label: 'Hb', labelBusca: "Hemoglobina", template: (v) => `Hb ${v} / ` },
      { id: 'ht', label: 'Ht', labelBusca: "Hematocrito", template: (v) => `Ht ${v} / ` },
      { id: 'leuco', label: 'Leuco', labelBusca: "Leucocitos", template: (v) => `Leuco ${v} / ` },
      { id: 'n', label: 'N', labelBusca: "Neutrofilos", template: (v) => `N ${v} / ` },
      { id: 'plaq', label: 'PLAQ', labelBusca: "Plaquetas", template: (v) => `PLAQ ${v} / ` },
      { id: 'inr', label: 'INR', labelBusca: "RNI", template: (v) => `INR ${v} / ` },
      { id: 'r', label: 'R', labelBusca: "Relacao paciente/normal", template: (v) => `R ${v} / ` },
      { id: 'u', label: 'U', labelBusca: "Ureia", template: (v) => `U ${v} / ` },
      { id: 'cr', label: 'Cr', labelBusca: "Creatinina", labelBuscaAlternativo: "Dosagem sérica de Creatinina", template: (v) => `Cr ${v} / ` },
      { id: 'na', label: 'Na', labelBusca: "Sódio", template: (v) => `Na ${v} / ` },
      { id: 'k', label: 'K', labelBusca: "Potassio", template: (v) => `K ${v} / ` },
      { id: 'mg', label: 'Mg', labelBusca: "Magnésio", template: (v) => `Mg ${v} / ` },
      { id: 'pcr', label: 'PCR', labelBusca: "Proteína C Reativa - PCR", template: (v) => `PCR ${v} / ` },
      { id: 'cai', label: 'Cai', labelBusca: "Calcio Ionizado", template: (v) => `Cai ${v} / ` },
      { id: 'bt', label: 'BT', labelBusca: "Bilirrubina Total", template: (v) => `BT ${v} / ` },
      { id: 'bd', label: 'BD', labelBusca: "Bilirrubina Direta", optional: true, template: (v) => `BD ${v} / ` },
      { id: 'bi', label: 'BI', labelBusca: "Bilirrubina Indireta", optional: true, template: (v) => `BI ${v} / ` },
      { id: 'tgo', label: 'TGO', labelBusca: "TGO/AST", template: (v) => `TGO ${v} / ` },
      { id: 'tgp', label: 'TGP', labelBusca: "TGP/ALT", template: (v) => `TGP ${v} / ` },
      { id: 'fal', label: 'FAL', labelBusca: "Fosfatase Alcalina", template: (v) => `FAL ${v} / ` },
      { id: 'ggt', label: 'GGT', labelBusca: "Gama Glutamil Transferase", template: (v) => `GGT ${v} / ` },
      { id: 'phart', label: 'pHart', labelBusca: "PH", usaTextoArterial: true, template: (v) => `pHart ${v} / ` },
      { id: 'so2art', label: 'SO2art', labelBusca: "Saturacao de O2", usaTextoArterial: true, template: (v) => `SO2art ${v} / ` },
      { id: 'hco3art', label: 'HCO3art', labelBusca: "Bicarbonato", usaTextoArterial: true, template: (v) => `HCO3art ${v} / ` },
      { id: 'beart', label: 'BEart', labelBusca: "Base Exces", usaTextoArterial: true, template: (v) => `BEart ${v} / ` },
      // Exames de Urina Tipo I (lógica antiga mantida por simplicidade)
      { id: 'u1ph', label: 'U1 pH', labelBusca: "pH", labelBuscaAlternativo: "Urina tipo I", template: (v) => `U1 pH ${v} / ` },
      { id: 'u1nitrito', label: 'U1 nitrito', labelBusca: "Nitrito", template: (v) => `U1 nitrito ${v} / ` },
      { id: 'u1leuco', label: 'U1 leuco', labelBusca: "Leucocitos", labelBuscaAlternativo: "Leucócitos", template: (v) => `U1 leuco ${v} / ` },
  ];

  // Agora, processa a lista de configuração para encontrar os valores
  const todosExames = configExames.map(exame => {
      if (exame.labelBusca) { // Se for um exame que usa a análise padrão
          const textoParaAnalisar = exame.usaTextoArterial ? textoArterial : texto;
          const analise = analisarExame(exame.labelBusca, textoParaAnalisar, exame.labelBuscaAlternativo);
          // Garante compatibilidade de nome do campo (valor → value)
          return { 
              ...exame, 
              value: analise.valor, 
              status: analise.status 
          };
      }
      return exame; // Retorna exames já processados (Data, Urina I)
  });

  // Filtra exames encontrados e ajusta a seleção para opcionais
  examesEncontradosGlobal = todosExames.filter(exame => exame.value !== null && exame.value !== undefined).map(exame => {
      // Define a seleção padrão: selecionado se NÃO for opcional. Se 'selected' já estiver definido (ex: Data), mantém.
      exame.selected = exame.selected !== undefined ? exame.selected : !exame.optional;
      return exame;
  });
  
  const examesEncontrados = examesEncontradosGlobal;
  // Lógica experimental para encontrar exames não previstos foi removida para estabilidade

  renderizarSidebar(examesEncontrados);
  gerarTextoFinal();
  salvarNoHistorico(examesEncontrados); // Salva automaticamente após análise
}

function renderizarSidebar(examesEncontrados) {
    const listaExamesUl = document.getElementById('lista-exames');
    if (examesEncontrados.length === 0) {
        listaExamesUl.innerHTML = '<li class="instructions">Nenhum exame reconhecido.</li>';
        return;
    }
    listaExamesUl.innerHTML = examesEncontrados.map(exame => `
        <li>
            <input type="checkbox" id="${exame.id}" onchange="atualizarSelecao('${exame.id}', this.checked)" ${exame.selected ? 'checked' : ''}>
            <label for="${exame.id}">${exame.label} (<span class="${exame.status === 'alterado' ? 'valor-alterado' : ''}">${exame.value}</span>)</label>
            ${exame.isNew ? '<span class="novo-exame-tag">NOVO</span>' : ''}
        </li>
    `).join('');
}

function atualizarSelecao(id, isSelected) {
    const exame = examesEncontradosGlobal.find(e => e.id === id);
    if (exame) {
        exame.selected = isSelected;
    }
    gerarTextoFinal();
}

function gerarTextoFinal() {
  // Compor string final
  let resultado = ">> ";
  // Usa a variável global que é a fonte da verdade
  examesEncontradosGlobal.forEach(exame => {
      if (exame.selected && exame.value !== null && exame.value !== undefined) {
          resultado += exame.template(exame.value);
      }
  });
  resultado = resultado.replace(/\/ $/, ''); // Remove última barra
  resultadoDiv.innerText = resultado.toUpperCase();
}

function salvarNoHistorico(examesEncontrados) {
  // Salvar resultado no histórico
  const texto = document.getElementById("input").value;
  const nomePaciente = pegarNomePaciente(texto);
  const dataCompleta = pegarDataCompleta(texto);
  const resultadoFinal = resultadoDiv.innerText;

  if (dataCompleta && resultadoFinal.length > 10) { // Só salva se tiver data e resultado
    const resultadosRecentes = JSON.parse(localStorage.getItem('resultadosRecentes') || '[]');
    const novoResultado = {
        id: Date.now(), // ID único para ordenação de grupos
        paciente: nomePaciente,
        dataCompleta: dataCompleta,
        resultado: resultadoFinal
    };
    resultadosRecentes.push(novoResultado);
    // Limita o histórico aos últimos 50 resultados para não sobrecarregar
    localStorage.setItem('resultadosRecentes', JSON.stringify(resultadosRecentes.slice(-50)));
    renderizarResultadosRecentes();
  }
}
  </script>
  <script>
    // Funções auxiliares para cópia individual
    function copiarTexto(texto) {
        navigator.clipboard.writeText(texto)
            .then(() => showToast('Resultado copiado!'))
            .catch(() => showToast('Falha ao copiar.'));
    }
  </script>
</body>
</html>
