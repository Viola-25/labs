<html lang="pt-br"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Processador de Laudos</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&amp;display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f8f9fa;
            --card-bg: #fff;
            --text-color: #2c3e50;
            --primary-color: #007bff;
            --primary-hover: #2980b9;
            --secondary-color: #95a5a6;
            --secondary-hover: #7f8c8d;
            --border-color: #e0e6ed;
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        html.dark-mode {
            --bg-color: #2c3e50;
            --card-bg: #34495e;
            --text-color: #ecf0f1;
            --primary-color: #0d6efd;
            --primary-hover: #5dade2;
            --secondary-color: #7f8c8d;
            --secondary-hover: #95a5a6;
            --border-color: #4a6572;
        }
        html.dark-mode .disclaimer {
            background-color: #4d442a;
            border-color: #a18849;
            color: #f7e8c3;
        }
        * {
            box-sizing: border-box; /* Garante que padding não aumente a largura total */
        }
        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 24px;
            transition: background-color 0.3s, color 0.3s;
        }
        /* Otimização para telas menores (celulares) */
        @media (max-width: 992px) {
            body { padding: 16px; }
            .page-wrapper { flex-direction: column; }
            .container, .sidebar { flex: none; width: 100%; }
        }
        .page-wrapper {
            display: flex;
            gap: 24px;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
        }
        .container {
            background-color: var(--card-bg);
            border-radius: 12px;
            box-shadow: var(--box-shadow);
            padding: 24px 32px;
            width: 100%;
            flex: 3; /* Ocupa 3 partes do espaço */
            transition: background-color 0.3s;
        }
        .sidebar {
            background-color: var(--card-bg);
            border-radius: 12px;
            box-shadow: var(--box-shadow);
            padding: 24px;
            width: 100%;
            flex: 1; /* Ocupa 1 parte do espaço */
            align-self: flex-start; /* Alinha ao topo */
        }
        .sidebar h2 {
            margin-top: 0;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }
        .search-input {
            width: 100%;
            padding: 10px 12px;
            margin-bottom: 16px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: 14px;
        }
        .search-input:focus {
            outline: 2px solid var(--primary-color);
        }
        #lista-exames {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 400px;
            padding-right: 8px; /* Espaço para a barra de rolagem */
            overflow-y: auto;
        }
        #lista-exames li {
            padding: 8px 4px;
            display: grid; /* Usar grid para melhor alinhamento */
            grid-template-columns: auto 1fr auto; /* Checkbox | Label | Valor */
            align-items: center;
            gap: 12px; /* Aumenta o espaçamento */
        }
        #lista-exames label {
            cursor: pointer; /* Melhora UX */
        }
        #lista-exames .exame-valor {
            font-weight: 500;
            justify-self: end; /* Alinha o valor à direita */
        }
        #lista-exames li:not(:last-child) {
            border-bottom: 1px solid var(--border-color);
        }
        #lista-exames input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }
        #lista-exames .valor-alterado {
            color: #e74c3c; /* Vermelho para alerta */
            font-weight: bold;
        }
        #lista-exames .valor-alterado::before {
            content: '⚠️ ';
        }
        #lista-exames .novo-exame-tag {
            background-color: var(--primary-color);
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 700;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 16px;
            margin-bottom: 24px;
        }
        h1 {
            font-size: 24px;
            font-weight: 700;
            margin: 0;
            color: var(--text-color);
        }
        p { line-height: 1.6; }
        textarea {
            width: 100%;
            min-height: 250px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 14px;
            resize: vertical;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        .actions {
            display: flex;
            gap: 12px;
            margin-top: 24px; /* Padronizando espaçamento (múltiplo de 8) */
            flex-wrap: wrap;
        }
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            flex-grow: 1;
        }
        button:active { transform: scale(0.98); }
        .btn-primary {
            background: linear-gradient(45deg, var(--primary-color), var(--primary-hover));
            color: white;
        }
        .btn-primary:hover { background-color: var(--primary-hover); }
        .btn-secondary {
            background-color: transparent;
            color: var(--secondary-hover);
            border: 1px solid var(--border-color);
        }
        .btn-secondary:hover { background-color: var(--bg-color); }
        #resultado {
            /* ... (estilos existentes) ... */
        }
        .resultado-wrapper {
            position: relative;
            margin-top: 16px;
        }
        #resultado {
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
            font-family: 'Courier New', Courier, monospace;
            font-weight: 500;
            line-height: 1.5;
            min-height: 40px;
            word-wrap: break-word;
            transition: background-color 0.3s, border-color 0.3s;
        }
        .copy-btn-individual {
            background: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 4px 8px;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s, background-color 0.2s;
            font-size: 12px;
            flex-shrink: 0; /* Impede que o botão encolha */
        }
        .copy-btn-individual:hover {
            opacity: 1;
            background-color: var(--primary-color);
        }
        #recentes-container {
            margin-top: 32px;
            border-top: 1px solid var(--border-color);
            padding-top: 16px;
        }
        .header-recentes {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        #btn-limpar-historico {
            background: transparent;
            border: none;
            color: var(--secondary-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .accordion-item {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 8px;
            overflow: hidden;
        }
        .accordion-header {
            background-color: var(--bg-color);
            padding: 12px 16px;
            cursor: pointer;
            font-weight: 700;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s; /* Adiciona transição suave */
        }
        .accordion-header:hover { 
            background-color: var(--border-color); /* Feedback visual mais claro */
        }
        .accordion-content {
            padding: 8px 16px;
            display: none; /* Escondido por padrão */
        }
        .resultado-recente-item {
            font-size: 14px;
            font-family: 'Courier New', Courier, monospace;
            font-weight: 500; /* Deixa a fonte mais forte */
            padding: 8px 0;
            border-bottom: 1px dashed var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
        }
        .accordion-content .resultado-recente-item:last-child {
            border-bottom: none;
        }
        .instructions {
            font-size: 14px;
            color: var(--secondary-hover);
        }
        .theme-switch-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--secondary-hover);
        }
        .theme-switch {
            display: inline-block;
            height: 24px;
            position: relative;
            width: 48px;
        }
        .theme-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            background-color: #ccc;
            bottom: 0;
            cursor: pointer;
            left: 0;
            position: absolute;
            right: 0;
            top: 0;
            transition: .4s;
        }
        .slider:before {
            background-color: white;
            bottom: 3px;
            content: "";
            height: 18px;
            left: 4px;
            position: absolute;
            transition: .4s;
            width: 18px;
        }
        input:checked + .slider {
            background-color: var(--primary-color);
        }
        input:checked + .slider:before {
            transform: translateX(22px);
        }
        .slider.round {
            border-radius: 24px;
        }
        .slider.round:before {
            border-radius: 50%;
        }
        /* Estilo para a notificação Toast */
        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: var(--card-bg); /* Usa variável para consistência */
            color: var(--text-color); /* Usa variável para consistência */
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            z-index: 10;
            left: 50%;
            transform: translateX(-50%);
            bottom: 30px;
            opacity: 0;
            transition: opacity 0.5s, bottom 0.5s, visibility 0.5s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        #toast.show {
            visibility: visible;
            opacity: 1;
            bottom: 50px; /* Efeito de deslizar para cima */
        }

        /* Estilos para o Modal de Confirmação */
        #confirmation-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: none; /* Escondido por padrão */
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        #confirmation-modal-overlay.show {
            display: flex; /* Mostra o modal */
        }
        #confirmation-modal {
            background-color: var(--card-bg);
            padding: 24px 32px;
            border-radius: 12px;
            box-shadow: var(--box-shadow);
            width: 90%;
            max-width: 450px;
            text-align: center;
        }
        #confirmation-modal h3 {
            margin-top: 0;
            font-size: 20px;
        }
        #confirmation-modal p {
            margin-bottom: 24px;
            color: var(--secondary-hover);
        }
        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }
        /* Fim dos estilos do Modal */
        .signature {
            text-align: center;
            font-size: 14px; /* Aumentei o tamanho da fonte */
            color: var(--secondary-hover);
            font-weight: 500;
            margin-top: 4px; /* Pequeno espaço abaixo do título */
            text-align: left; /* Alinhado com o título */
        }
        .download-section {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid var(--border-color);
            text-align: center;
        }
        .download-section button {
            max-width: 300px; /* Limita a largura do botão */
        }
        .download-disclaimer {
            font-size: 13px;
            color: var(--secondary-hover);
            margin-top: 12px;
        }
        .disclaimer {
            background-color: #fffbe6; /* Amarelo claro */
            border: 1px solid #ffe58f;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 16px;
            font-size: 14px;
            color: #8a6d3b;
            line-height: 1.5;
            text-align: center;
        }

    </style>
</head>
<body>
    <main class="page-wrapper">
        <div class="container"> <!-- Conteúdo Principal -->
            <div class="header">
                <div>
                    <h1>Processador de Laudos</h1>
                    <div class="signature">Feito por Enzo Viola - Turma XXVIII - MEDSC</div>
                </div>
                <div class="theme-switch-wrapper">
                    <span>Modo Escuro</span>
                    <label class="theme-switch" for="theme-toggle" title="Alternar tema">
                        <input type="checkbox" id="theme-toggle">
                        <div class="slider round"></div>
                    </label>
                </div>
            </div>
            <div class="instructions">
                <p><strong>Como usar:</strong><br>
                1. Na página do laudo, aperte <strong>CTRL+A</strong> (para selecionar tudo) e depois <strong>CTRL+C</strong> (para copiar).<br>
                2. Cole na caixa abaixo e clique em <strong>Analisar Laudo</strong>. Selecione os exames na barra lateral para gerar o resultado formatado, pronto para colar no prontuário.<br>
                <small><strong>Atenção:</strong> No momento, o script é otimizado para laudos da <strong>AFIP</strong>.</small></p>
            </div>
            <div class="disclaimer">
                <strong>Atenção (BETA):</strong> Esta ferramenta é um auxílio e está em fase de testes. Sempre confira os resultados e os valores de referência com o laudo original antes de tomar qualquer decisão clínica.
            </div>
            <textarea id="input" placeholder="Aguardando dados do laudo..."></textarea>
            <div class="actions">
                <button id="btn-processar" class="btn-primary">Analisar Laudo</button>
                <button id="btn-copiar" class="btn-secondary">Copiar Resultado</button>
                <button id="btn-limpar-campos" class="btn-secondary">Limpar Campos</button>
            </div>
            <div class="resultado-wrapper">
                <div class="header header-no-border">
                    <p style="margin: 0;"><strong>Resultado Final:</strong></p>
                    <div class="theme-switch-wrapper" style="font-size: 14px;">
                        <span>Marcar alterados</span>
                        <label class="theme-switch" for="marcar-alterados-toggle" title="Adicionar '*' aos resultados alterados">
                            <input type="checkbox" id="marcar-alterados-toggle">
                            <div class="slider round"></div>
                        </label>
                    </div>
                </div>
                <div id="resultado"></div>
            </div>

            <div class="download-section">
                <button id="btn-baixar" class="btn-secondary">Baixar para Uso Offline</button>
                <p class="download-disclaimer">
                    <strong>Atenção:</strong> O script baixado não recebe atualizações automáticas. A versão mais recente, com correções e novos exames, está sempre disponível em <a href="https://bit.ly/labsfacil" target="_blank" rel="noopener noreferrer">bit.ly/labsfacil</a>. Recomendamos baixar uma nova versão periodicamente.
                </p>
            </div>
    
            <div id="recentes-container">
                <div class="header-recentes">
                    <h2>Resultados Recentes</h2>
                    <button id="btn-limpar-historico">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"></path>
                            <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"></path>
                        </svg>
                        Limpar Histórico
                    </button>
                </div>
                <div id="lista-recentes"><div class="accordion-item"><div class="accordion-header"><span>Paciente Desconhecido</span><span>▼</span></div><div class="accordion-content"><div class="resultado-recente-item">
                            <span>&gt;&gt; 02/11: N 919 / R 3 / U 37.0 / CR 0.70 / NA 140 / K 4.1 / PCR 12.80</span>
                            <button class="copy-btn-individual" title="Copiar este resultado" data-copy-text="&gt;&gt; 02/11: N 919 / R 3 / U 37.0 / CR 0.70 / NA 140 / K 4.1 / PCR 12.80">Copiar</button>
                         </div><div class="resultado-recente-item">
                            <span>&gt;&gt; 02/11: N 919 / R 3 / U 37.0 / CR 0.70 / NA 140 / K 4.1 / PCR 12.80</span>
                            <button class="copy-btn-individual" title="Copiar este resultado" data-copy-text="&gt;&gt; 02/11: N 919 / R 3 / U 37.0 / CR 0.70 / NA 140 / K 4.1 / PCR 12.80">Copiar</button>
                         </div></div></div></div>
            </div>

            <!-- Elemento da notificação Toast -->
            <div id="toast"></div>
        </div>

        <aside class="sidebar">
            <h2>Exames Encontrados</h2>
            <input type="text" id="filtro-exames" class="search-input" placeholder="Buscar exame...">
            <ul id="lista-exames">
                <li class="instructions">Analise um laudo para ver os exames aqui.</li>
            </ul>
        </aside>
    </main>

    <!-- Modal de Confirmação -->
    <div id="confirmation-modal-overlay">
        <div id="confirmation-modal">
            <h3>Confirmar Ação</h3>
            <p>Tem certeza que deseja apagar todo o histórico de resultados? Esta ação não pode ser desfeita.</p>
            <div class="modal-actions">
                <button id="btn-confirm-delete" class="btn-primary">Sim, apagar</button>
                <button id="btn-cancel-delete" class="btn-secondary">Cancelar</button>
            </div>
        </div>
    </div>

  <script>
    // Cache de seletores do DOM para melhor performance e manutenção
    const inputArea = document.getElementById('input');
    const resultadoDiv = document.getElementById('resultado');
    const listaExamesUl = document.getElementById('lista-exames');
    const filtroExamesInput = document.getElementById('filtro-exames');
    const listaRecentesDiv = document.getElementById('lista-recentes');
    const themeToggle = document.getElementById('theme-toggle');
    const marcarAlteradosToggle = document.getElementById('marcar-alterados-toggle');
    const toastEl = document.getElementById('toast');

    // Botões
    const btnProcessar = document.getElementById('btn-processar');
    const btnCopiarResultado = document.getElementById('btn-copiar');
    const btnLimparCampos = document.getElementById('btn-limpar-campos');
    const btnBaixarScript = document.getElementById('btn-baixar');
    const btnLimparHistorico = document.getElementById('btn-limpar-historico');
    const btnConfirmDelete = document.getElementById('btn-confirm-delete');
    const btnCancelDelete = document.getElementById('btn-cancel-delete');

    // Modal
    const modalOverlay = document.getElementById('confirmation-modal-overlay');

    // --- LÓGICA DE INICIALIZAÇÃO E EVENTOS ---

    document.addEventListener('DOMContentLoaded', () => {
        setupEventListeners();
        loadTheme();
        renderizarResultadosRecentes();
    });

    function loadTheme() {
    if (localStorage.getItem('darkMode') === 'enabled') {
        document.documentElement.classList.add('dark-mode');
        themeToggle.checked = true;
    }

    themeToggle.addEventListener('change', () => {
        document.documentElement.classList.toggle('dark-mode');
        // Salva a preferência no localStorage
        if (document.documentElement.classList.contains('dark-mode')) {
            localStorage.setItem('darkMode', 'enabled');
        } else {
            localStorage.setItem('darkMode', 'disabled');
        }
    });

    function setupEventListeners() {
        btnProcessar.addEventListener('click', processar);
        btnCopiarResultado.addEventListener('click', copiarResultado);
        btnLimparCampos.addEventListener('click', limparTudo);
        btnBaixarScript.addEventListener('click', baixarScript);
        filtroExamesInput.addEventListener('input', filtrarExames);
        marcarAlteradosToggle.addEventListener('change', gerarTextoFinal);

        // Event listeners para o histórico e modal
        btnLimparHistorico.addEventListener('click', showConfirmationModal);
        btnConfirmDelete.addEventListener('click', handleConfirmDelete);
        btnCancelDelete.addEventListener('click', hideConfirmationModal);
        listaRecentesDiv.addEventListener('click', handleHistoricoClick);
        listaExamesUl.addEventListener('change', handleSelecaoExame);
    }

    // --- FUNÇÕES DE UI (TOAST, MODAL, ETC) ---

    let toastTimeout; // Variável para controlar o timeout do toast

    function showToast(message) {
        toastEl.textContent = message;
        toastEl.classList.add("show");

        // Limpa o timeout anterior se houver um
        clearTimeout(toastTimeout);

        // Esconde o toast após 3 segundos
        toastTimeout = setTimeout(() => {
            toastEl.classList.remove("show");
        }, 3000);
    }

    function copiarResultado() {
        const textoResultado = resultadoDiv.textContent;
        if (textoResultado) {
            navigator.clipboard.writeText(textoResultado)
                .then(() => showToast('Resultado copiado!'))
                .catch(() => showToast('Falha ao copiar.'));
        } else {
            showToast('Nada para copiar.');
        }
    }

    function limparTudo() {
        inputArea.value = '';
        listaExamesUl.innerHTML = '<li class="instructions">Analise um laudo para ver os exames aqui.</li>';
        resultadoDiv.textContent = '';
    }

    function showConfirmationModal() {
        modalOverlay.classList.add('show');
    }

    function hideConfirmationModal() {
        modalOverlay.classList.remove('show');
    }

    function handleConfirmDelete() {
        localStorage.removeItem('resultadosRecentes');
        renderizarResultadosRecentes();
        hideConfirmationModal();
        showToast('Histórico limpo com sucesso!');
    }

    // --- LÓGICA DO HISTÓRICO DE RESULTADOS ---

    function renderizarResultadosRecentes() {
        const resultados = JSON.parse(localStorage.getItem('resultadosRecentes') || '[]');
        
        if (resultados.length === 0) {
            listaRecentesDiv.innerHTML = '<p class="instructions">Nenhum resultado processado ainda.</p>';
            return;
        }

        // Agrupa resultados por paciente
        const agrupados = resultados.reduce((acc, res) => {
            acc[res.paciente] = acc[res.paciente] || [];
            acc[res.paciente].push(res);
            return acc;
        }, {});

        let html = '';
        // Ordena pacientes pelo mais recente
        const pacientesOrdenados = Object.keys(agrupados).sort((a, b) => {
            const dataA = Math.max(...agrupados[a].map(r => r.id));
            const dataB = Math.max(...agrupados[b].map(r => r.id));
            return dataB - dataA;
        });

        for (const paciente of pacientesOrdenados) {
            html += `<div class="accordion-item">`;
            html += `<div class="accordion-header"><span>${paciente}</span><span>▼</span></div>`;
            html += `<div class="accordion-content">`;

            // Ordena resultados do paciente por data (mais novo primeiro)
            agrupados[paciente].sort((a, b) => new Date(b.dataCompleta) - new Date(a.dataCompleta));

            for (const res of agrupados[paciente]) {
                const resultadoEscapado = res.resultado.replace(/'/g, "&apos;").replace(/"/g, "&quot;");
                html += `<div class="resultado-recente-item">
                            <span>${res.resultado}</span>
                            <button class="copy-btn-individual" title="Copiar este resultado" data-copy-text='${resultadoEscapado}'>Copiar</button>
                         </div>`;
            }
            html += `</div></div>`;
        }

        listaRecentesDiv.innerHTML = html;
    }

    function handleHistoricoClick(event) {
        const header = event.target.closest('.accordion-header');
        if (header) {
            const content = header.nextElementSibling;
            const icon = header.querySelector('span:last-child');
            const isVisible = content.style.display === 'block';
            content.style.display = isVisible ? 'none' : 'block';
            icon.textContent = isVisible ? '▼' : '▲';
            return;
        }

        const copyBtn = event.target.closest('.copy-btn-individual');
        if (copyBtn && copyBtn.dataset.copyText) {
            copiarTexto(copyBtn.dataset.copyText);
        }
    }

    // --- LÓGICA PRINCIPAL DE PROCESSAMENTO DE LAUDOS ---
    
    // Estrutura de configuração para todos os exames conhecidos
    const CONFIG_EXAMES_BASE = [
    // --- HEMOGRAMA ---
        { id: 'hb', label: 'Hb', nomesBusca: ["Hemoglobina"], template: (v) => `Hb ${v} / `, ref: { M: { min: 13.5, max: 17.5 }, F: { min: 12.0, max: 15.5 } } },
        { id: 'ht', label: 'Ht', nomesBusca: ["Hematocrito"], template: (v) => `Ht ${v} / `, ref: { M: { min: 40, max: 50 }, F: { min: 36, max: 46 } } },
        { id: 'leuco', label: 'Leuco', nomesBusca: ["Leucocitos"], template: (v) => `Leuco ${v} / `, ref: { min: 4.0, max: 11.0 } }, // Em 10^3/mm³
        { id: 'n', label: 'N', nomesBusca: ["Neutrofilos"], template: (v) => `N ${v} / `, ref: { min: 1.8, max: 7.7 } }, // Em 10^3/mm³
        { id: 'plaq', label: 'PLAQ', nomesBusca: ["Plaquetas"], template: (v) => `PLAQ ${v} / `, ref: { min: 150, max: 450 } }, // Em 10^3/mm³
        
        // --- COAGULAÇÃO ---
        { id: 'inr', label: 'INR', nomesBusca: ["RNI"], template: (v) => `INR ${v} / `, ref: { min: 1.0, max: 1.2 } }, // Ref laboratorial. Lógica especial trata a faixa terapêutica.
        { id: 'r', label: 'R', nomesBusca: ["Relacao paciente/normal"], template: (v) => `R ${v} / `, ref: { min: 0.85, max: 1.20 } },
        { id: 'dimd', label: 'D-Dim', nomesBusca: ["D-Dimero"], template: (v) => `D-Dim ${v} / `, ref: { min: -Infinity, max: 500 } },

        // --- FUNÇÃO RENAL E ELETRÓLITOS ---
        { id: 'u', label: 'U', nomesBusca: ["Ureia", "Ureia, sérica"], template: (v) => `U ${v} / `, ref: { M: { min: 19, max: 43 }, F: { min: 15, max: 36 } } },
        { id: 'cr', label: 'Cr', nomesBusca: ["Creatinina", "Dosagem sérica de Creatinina"], template: (v) => `Cr ${v} / `, ref: { min: 0.7, max: 1.3 } },
	{ id: 'tfg', label: 'TFG', nomesBusca: ["TFG", "TFG - Taxa de Filtração Glomerular"], optional: true, template: (v) => `TFG ${v} / `, ref: { min: 90, max: Infinity } },
        { id: 'au', label: 'AU', nomesBusca: ["Acido Urico"], template: (v) => `AU ${v} / `, ref: { M: { min: 3.5, max: 7.2 }, F: { min: 2.6, max: 6.0 } } },
        { id: 'na', label: 'Na', nomesBusca: ["Sódio"], template: (v) => `Na ${v} / `, ref: { min: 135, max: 145 } },
        { id: 'k', label: 'K', nomesBusca: ["Potassio"], template: (v) => `K ${v} / `, ref: { min: 3.5, max: 5.0 } },
        { id: 'cl', label: 'Cl', nomesBusca: ["Cloro"], template: (v) => `Cl ${v} / `, ref: { min: 98, max: 107 } },
        { id: 'mg', label: 'Mg', nomesBusca: ["Magnésio"], template: (v) => `Mg ${v} / `, ref: { min: 1.8, max: 2.4 } },
        { id: 'cai', label: 'Cai', nomesBusca: ["Calcio Ionizado"], template: (v) => `Cai ${v} / `, ref: { min: 1.12, max: 1.30 } },
        { id: 'ca', label: 'Ca', nomesBusca: ["Calcio"], template: (v) => `Ca ${v} / `, ref: { min: 8.4, max: 11.0 } },
        { id: 'p', label: 'P', nomesBusca: ["Fosforo"], template: (v) => `P ${v} / `, ref: { min: 2.5, max: 4.5 } },
        
        // --- PERFIL LIPÍDICO ---
        { id: 'ct', label: 'CT', nomesBusca: ["Colesterol Total"], template: (v) => `CT ${v} / `, ref: { min: -Infinity, max: 190 } },
        { id: 'hdl', label: 'HDL', nomesBusca: ["Colesterol HDL"], template: (v) => `HDL ${v} / `, ref: { M: { min: 40, max: Infinity }, F: { min: 50, max: Infinity } } },
        { id: 'ldl', label: 'LDL', nomesBusca: ["Colesterol LDL"], template: (v) => `LDL ${v} / `, ref: { min: -Infinity, max: 130 } },
        { id: 'tg', label: 'TGL', nomesBusca: ["Triglicerides", "TGL"], template: (v) => `TGL ${v} / `, ref: { min: -Infinity, max: 175 } }, // Usando valor de sem jejum como teto
        { id: 'vldl', label: 'VLDL', nomesBusca: ["Colesterol VLDL"], template: (v) => `VLDL ${v} / `, ref: { min: -Infinity, max: 30 } },

        // --- BIOQUÍMICA GERAL / INFLAMATÓRIOS ---
        { id: 'glic', label: 'Glic', nomesBusca: ["Glicose", "Glicemia"], template: (v) => `Glic ${v} / `, ref: { min: 70, max: 99 } },
        { id: 'pcr', label: 'PCR', nomesBusca: ["Proteína C Reativa - PCR"], template: (v) => `PCR ${v} / `, ref: { min: -Infinity, max: 0.5 } }, // Em mg/dL
        { id: 'lact', label: 'Lact', nomesBusca: ["Lactato"], template: (v) => `Lact ${v} / `, ref: { min: 0.5, max: 2.2 } },
        { id: 'alb', label: 'Alb', nomesBusca: ["Albumina"], template: (v) => `Alb ${v} / `, ref: { min: 3.5, max: 5.0 } },
        { id: 'pt', label: 'PT', nomesBusca: ["Proteinas Totais"], template: (v) => `PT ${v} / `, ref: { min: 6.0, max: 8.3 } },
        { id: 'glob', label: 'Glob', nomesBusca: ["Globulina"], template: (v) => `Glob ${v} / `, ref: { min: 2.0, max: 3.5 } },

        // --- FUNÇÃO HEPÁTICA / BILI ---
        { id: 'bt', label: 'BT', nomesBusca: ["Bilirrubina Total"], template: (v) => `BT ${v} / `, ref: { min: 0.2, max: 1.2 }, ignorarBaixo: true },
        { id: 'bd', label: 'BD', nomesBusca: ["Bilirrubina Direta"], optional: true, template: (v) => `BD ${v} / `, ref: { min: 0.0, max: 0.3 } },
        { id: 'bi', label: 'BI', nomesBusca: ["Bilirrubina Indireta"], optional: true, template: (v) => `BI ${v} / `, ref: { min: 0.1, max: 0.8 } },
        { id: 'tgo', label: 'TGO', nomesBusca: ["TGO/AST"], template: (v) => `TGO ${v} / `, ref: { M: { min: 10, max: 40 }, F: { min: 14, max: 36 } } },
        { id: 'tgp', label: 'TGP', nomesBusca: ["TGP/ALT"], template: (v) => `TGP ${v} / `, ref: { min: 10, max: 40 } },
        { id: 'fal', label: 'FAL', nomesBusca: ["Fosfatase Alcalina"], template: (v) => `FAL ${v} / `, ref: { min: 30, max: 120 } },
        { id: 'dhl', label: 'DHL', nomesBusca: ["DHL", "Desidrogenase Lática"], template: (v) => `DHL ${v} / `, ref: { min: 140, max: 280 } },
        { id: 'hba1c', label: 'HbA1c', nomesBusca: ["Hemoglobina Glicada", "HbA1c"], template: (v) => `HbA1c ${v} / `, ref: { min: -Infinity, max: 5.7 } },
        { id: 'ggt', label: 'GGT', nomesBusca: ["Gama Glutamil Transferase"], template: (v) => `GGT ${v} / `, ref: { min: 5, max: 40 } },

        // --- ENZIMAS CARDÍACAS ---
        { id: 'trop', label: 'Trop', nomesBusca: ["Troponina I"], template: (v) => `Trop ${v} / `, ref: { min: -Infinity, max: 0.014 } }, // ng/mL
        { id: 'ckmb', label: 'CKMB', nomesBusca: ["CK-MB"], template: (v) => `CKMB ${v} / `, ref: { min: -Infinity, max: 25 } },
        { id: 'ck', label: 'CK', nomesBusca: ["CK Total", "Creatinoquinase"], template: (v) => `CK ${v} / `, ref: { M: { min: 35, max: 200 }, F: { min: 30, max: 150 } } },
        { id: 'bnp', label: 'BNP', nomesBusca: ["BNP", "NT-proBNP"], template: (v) => `BNP ${v} / `, ref: { min: -Infinity, max: 100 } }, // Para BNP, NT-proBNP é diferente

        // --- ENZIMAS PANCREÁTICAS ---
        { id: 'amil', label: 'Amil', nomesBusca: ["Amilase"], template: (v) => `Amil ${v} / `, ref: { min: 25, max: 125 } },
        { id: 'lip', label: 'Lip', nomesBusca: ["Lipase"], template: (v) => `Lip ${v} / `, ref: { min: 10, max: 140 } },

        // --- MICROBIOLOGIA ---
        { 
            id: 'hmc', 
            label: 'HMC', 
            nomesBusca: ["Hemocultura"], 
            tipo: 'texto',
            template: (v) => {
                const valorLimpo = v.toLowerCase();
                if (valorLimpo.includes("não houve crescimento") || valorLimpo.includes("nao houve crescimento")) {
                    return 'HMC SCB / ';
                }
                if (valorLimpo.includes("crescimento")) {
                    return 'HMC POS / ';
                }
                return `HMC ${v} / `;
            } 
        },

        // --- ENDOCRINOLOGIA ---
        { id: 'tsh', label: 'TSH', nomesBusca: ["TSH"], template: (v) => `TSH ${v} / `, ref: { min: 0.4, max: 4.5 } },
        { id: 't4l', label: 'T4L', nomesBusca: ["T4 Livre"], template: (v) => `T4L ${v} / `, ref: { min: 0.8, max: 1.8 } },
        { id: 't3l', label: 'T3L', nomesBusca: ["T3 Livre"], template: (v) => `T3L ${v} / `, ref: { min: 2.0, max: 4.4 } },
        { id: 't3t', label: 'T3T', nomesBusca: ["T3 Total"], template: (v) => `T3T ${v} / `, ref: { min: 80, max: 200 } },
        { id: 'atpo', label: 'Anti-TPO', nomesBusca: ["Anti-TPO"], template: (v) => `Anti-TPO ${v} / `, ref: { min: -Infinity, max: 35 } },
        { id: 'atg', label: 'Anti-TG', nomesBusca: ["Anti-Tireoglobulina"], template: (v) => `Anti-TG ${v} / `, ref: { min: -Infinity, max: 40 } },
        { id: 'vitd', label: 'Vit.D', nomesBusca: ["Vitamina D", "25-hidroxivitamina D"], template: (v) => `Vit.D ${v} / `, ref: { min: 20, max: 50 } },
        { id: 'pth', label: 'PTH', nomesBusca: ["PTH", "Paratormonio"], template: (v) => `PTH ${v} / `, ref: { min: 15, max: 65 } },

        // --- MARCADORES TUMORAIS ---
        { id: 'psa', label: 'PSA', nomesBusca: ["PSA"], template: (v) => `PSA ${v} / `, ref: { min: -Infinity, max: 4.0 } },
        { id: 'cea', label: 'CEA', nomesBusca: ["CEA"], template: (v) => `CEA ${v} / `, ref: { min: -Infinity, max: 5.0 } },
        { id: 'afp', label: 'AFP', nomesBusca: ["Alfa-fetoproteína"], template: (v) => `AFP ${v} / `, ref: { min: -Infinity, max: 10 } },
        { id: 'ca199', label: 'CA19-9', nomesBusca: ["CA 19-9"], template: (v) => `CA19-9 ${v.replace(/\.(?=.*\d{3},)/g, '')} / `, ref: { min: -Infinity, max: 37 } },
        { id: 'ca125', label: 'CA125', nomesBusca: ["CA 125"], template: (v) => `CA125 ${v} / `, ref: { min: -Infinity, max: 35 } },
        { id: 'ca153', label: 'CA15-3', nomesBusca: ["CA 15-3"], template: (v) => `CA15-3 ${v} / `, ref: { min: -Infinity, max: 30 } },
        { id: 'bhcg', label: 'Beta-HCG', nomesBusca: ["Beta-HCG"], template: (v) => `Beta-HCG ${v} / `, ref: { min: -Infinity, max: 5 } },

        // --- SOROLOGIAS (Exemplos) ---
        // Adicionar sorologias aqui conforme necessário, podem precisar de lógica de texto (Positivo/Negativo)

        // --- GASOMETRIA ARTERIAL ---
        { id: 'phart', label: 'pHart', nomesBusca: ["PH"], usaTextoArterial: true, template: (v) => `pHart ${v} / `, ref: { min: 7.35, max: 7.45 } },
        { id: 'po2art', label: 'pO2art', nomesBusca: ["PO2"], usaTextoArterial: true, template: (v) => `pO2art ${v} / `, ref: { min: 80, max: 100 } },
        { id: 'pco2art', label: 'pCO2art', nomesBusca: ["PCO2"], usaTextoArterial: true, template: (v) => `pCO2art ${v} / `, ref: { min: 35, max: 40 } },
        { id: 'so2art', label: 'SO2art', nomesBusca: ["Saturacao de O2"], usaTextoArterial: true, template: (v) => `SO2art ${v} / `, ref: { min: 95, max: 100 } },
        { id: 'hco3art', label: 'HCO3art', nomesBusca: ["Bicarbonato"], usaTextoArterial: true, template: (v) => `HCO3art ${v} / `, ref: { min: 22, max: 26 } },
        { id: 'beart', label: 'BEart', nomesBusca: ["Base Exces"], usaTextoArterial: true, template: (v) => `BEart ${v} / `, ref: { min: -2, max: 2 } },
        { id: 'lactart', label: 'Lactart', nomesBusca: ["Lactato Arterial"], template: (v) => `Lactart ${v} / `, ref: { min: 0.5, max: 1.6 } },
        
        // --- GASOMETRIA VENOSA ---
        { id: 'phven', label: 'pHven', nomesBusca: ["PH"], usaTextoVenoso: true, template: (v) => `pHven ${v} / `, ref: { min: 7.31, max: 7.41 } },
        { id: 'po2ven', label: 'pO2ven', nomesBusca: ["PO2"], usaTextoVenoso: true, template: (v) => `pO2ven ${v} / `, ref: { min: 30, max: 40 } },
        { id: 'pco2ven', label: 'pCO2ven', nomesBusca: ["PCO2"], usaTextoVenoso: true, template: (v) => `pCO2ven ${v} / `, ref: { min: 41, max: 51 } },
        { id: 'so2ven', label: 'SO2ven', nomesBusca: ["Saturacao de O2"], usaTextoVenoso: true, template: (v) => `SO2ven ${v} / ` }, // Sem ref padrão
        { id: 'hco3ven', label: 'HCO3ven', nomesBusca: ["Bicarbonato"], usaTextoVenoso: true, template: (v) => `HCO3ven ${v} / `, ref: { min: 23, max: 29 } },
        { id: 'beven', label: 'BEven', nomesBusca: ["Base Exces"], usaTextoVenoso: true, template: (v) => `BEven ${v} / `, ref: { min: -2, max: 2 } },
        { id: 'lactven', label: 'Lactven', nomesBusca: ["Lactato"], usaTextoVenoso: true, template: (v) => `Lactven ${v} / `, ref: { min: 0.5, max: 2.2 } },

        // --- EXAMES DE URINA ---
        { id: 'u1ph', label: 'U1 pH', nomesBusca: ["pH", "Urina tipo I"], usaTextoUrina: true, template: (v) => `U1 pH ${v} / `, ref: { min: 4.5, max: 8.0 } },
        { id: 'u1nitrito', label: 'U1 nitrito', nomesBusca: ["Nitrito"], usaTextoUrina: true, tipo: 'texto', template: (v) => `U1 nitrito ${v} / ` },
        { id: 'u1leuco', label: 'U1 leuco', nomesBusca: ["Leucocitos", "Leucócitos"], usaTextoUrina: true, tipo: 'texto', template: (v) => `U1 leuco ${v} / ` },
    ];

    let examesEncontradosGlobal = [];

    function removerAcentos(str) {
        return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    }

    // Pega data mais proxima no texto
    function pegarData(texto) {
        const m = texto.match(/Coleta:\s*([\d\/]{8,10})/i);
        return m ? m[1].replace(/\/\d{4}$/, '') : null;
    }
    // Pega o nome do paciente
    function pegarNomePaciente(texto) {
        const m = texto.match(/Paciente:\s*([^\n]+)/i);
        return m ? m[1].trim() : "Paciente Desconhecido";
    }
    // Pega a data completa para ordenação
    function pegarDataCompleta(texto) {
        const m = texto.match(/Coleta:\s*([\d\/]{8,10})/i);
        if (!m) return null;
        const [dia, mes, ano] = m[1].split('/');
        return `${ano}-${mes}-${dia}`; // Formato YYYY-MM-DD para fácil ordenação
    }

    function pegarSexoPaciente(texto) {
        const m = texto.match(/Sexo:\s*(Masculino|Feminino)/i);
        // Retorna 'M' para Masculino, 'F' para Feminino, ou null se não encontrar
        if (m && m[1]) {
            return m[1].toUpperCase().startsWith('M') ? 'M' : 'F';
        }
        return null;
    }

    function isForaDoIntervalo(valor, referencia, ignorarBaixo = false) {
        if (!referencia) return false;
        const abaixoDoMinimo = !ignorarBaixo && valor < referencia.min;
        return (
            (referencia.min === -Infinity && valor >= referencia.max) || // Limite superior (ex: < 100)
            (referencia.max === Infinity && valor <= referencia.min) || // Limite inferior (ex: > 10)
            (abaixoDoMinimo || valor > referencia.max)                   // Intervalo (ex: 10-20)
        );
    }

    function analisarExame(exameConfig, textoParaAnalisar, sexoPaciente, todosNomesBuscaArray) {
        const { nomesBusca, tipo, ignorarBaixo } = exameConfig;
        
        const criarRegexBusca = (lbl) => {
            const lblSemAcentos = removerAcentos(lbl);
            let regexStr = lblSemAcentos.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
            if (lbl.toLowerCase() === 'lactato') regexStr = 'Lactato(?! Arterial)';
            const nomesBuscaAtuais = exameConfig.nomesBusca.map(nome => removerAcentos(nome).replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'));
	    const todosNomesBuscaFiltrado = todosNomesBuscaArray.filter(nome => !nomesBuscaAtuais.includes(nome)).join('|');
	    return new RegExp(`(^|\\n)(${regexStr}(?![a-zA-Z0-9])[\\s\\S]*?)(?=(?:\\n\\s*|\\s{2,})(?:${todosNomesBuscaFiltrado})|\\nLiberado por|$)`, "i");
        };
        let blocoExame = null;
        for (const nome of nomesBusca) {
            const re = criarRegexBusca(nome);
            blocoExame = textoParaAnalisar.match(re);
            if (blocoExame) break;
        }

        if (!blocoExame || !blocoExame[2]) return { ...exameConfig, value: null, status: 'nao_encontrado' };
        
        const textoBloco = blocoExame[2];

        if (tipo === 'texto') { // Lógica para exames qualitativos (ex: Hemocultura)
            const textoRegex = /(?:Microrganismo:|Resultado)\s*([^\n]+)/i;
            let textoMatch = textoBloco.match(textoRegex);
            if (textoMatch && textoMatch[1]) {
                const valorTexto = textoMatch[1].trim().replace(/\.$/, '').trim();
                return { ...exameConfig, value: valorTexto, status: 'normal' };
            }
            return { ...exameConfig, value: null, status: 'nao_encontrado' };
        }

        // Lógica para exames quantitativos
        let valorMatch;
        const resultadoRegex = /^\s*Resultado\s*([^\n]+)/im;
        valorMatch = textoBloco.match(resultadoRegex);

        if (!valorMatch) {
            for (const nome of nomesBusca) {
                const mesmaLinhaRegex = new RegExp(`^${removerAcentos(nome).replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')}\\s*(-?\\d[\\d,.-]*)`, "im");
                valorMatch = textoBloco.match(mesmaLinhaRegex);
                if (valorMatch) break;
            }
        }

        if (!valorMatch) {
            valorMatch = textoBloco.match(/(?:\s|\n)(-?\d[\d,.-]*)/);
        }

        if (nomesBusca.some(n => n.toLowerCase().includes("neutrofilos"))) {
            const neutrofilosRegex = /[\d,.-]+\s*\n+\s*([\d,.-]+)/i;
            const neutrofilosMatch = textoBloco.match(neutrofilosRegex);
            if (neutrofilosMatch && neutrofilosMatch[1]) valorMatch = neutrofilosMatch;
        }

        if (!valorMatch || !valorMatch[1]) return { ...exameConfig, value: null, status: 'nao_encontrado' };
        
        const valorStr = valorMatch[1].replace(',', '.').trim();
        const valorNum = parseFloat(valorStr);
        let status = 'normal';

        if (isNaN(valorNum)) {
            return { ...exameConfig, value: valorStr, status: 'normal' };
        }

        let referencia = exameConfig.ref;
        if (referencia && (referencia.M || referencia.F)) { // Se a referência depende do sexo
            referencia = sexoPaciente ? referencia[sexoPaciente] : (referencia.M || referencia.F);
        }

        // Regra especial para INR: considera a faixa terapêutica
        if (exameConfig.id === 'inr' && valorNum >= 2.0 && valorNum <= 3.0) {
            status = 'normal'; // Considera normal se estiver na faixa terapêutica
            return { ...exameConfig, value: valorStr, status: status };
        }

        if (isForaDoIntervalo(valorNum, referencia, ignorarBaixo)) {
            status = 'alterado';
        }

        return { ...exameConfig, value: valorStr, status: status };
    }

    function processar() {
        const texto = inputArea.value;
        if (!texto.trim()) {
            showToast("A área de texto está vazia.");
            return;
        }

        const textoSemAcentos = removerAcentos(texto);
        const sexoPaciente = pegarSexoPaciente(texto);
        const blocoUrina = (texto.match(/(Urina tipo I|EAS)([\s\S]*?)(?=Liberado por|$)/i) || [])[0] || "";

        let configExames = [...CONFIG_EXAMES_BASE];
        if (!blocoUrina) {
            configExames = configExames.filter(e => !e.usaTextoUrina);
        }
        
        // Gera a string de regex para o lookahead uma única vez
        const todosNomesBuscaArray = configExames.flatMap(e => e.nomesBusca).map(nome => removerAcentos(nome).replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'));
        const blocoGasometriaArterial = (texto.match(/Gasometria Arterial([\s\S]*?)(?=Gasometria Venosa|Liberado por|$)/i) || [])[0] || "";
        const blocoGasometriaVenosa = (texto.match(/Gasometria Venosa([\s\S]*?)(?=Gasometria Arterial|Liberado por|$)/i) || [])[0] || "";

        const todosExames = configExames.map(exame => {
            if (exame.nomesBusca) {
                let textoParaAnalisar = textoSemAcentos;
                if (exame.usaTextoArterial) textoParaAnalisar = removerAcentos(blocoGasometriaArterial);
                else if (exame.usaTextoVenoso) textoParaAnalisar = removerAcentos(blocoGasometriaVenosa);
                else if (exame.usaTextoUrina) textoParaAnalisar = removerAcentos(blocoUrina);

                if (!textoParaAnalisar) {
                    return { ...exame, value: null, status: 'nao_encontrado' };
                }

                return analisarExame(exame, textoParaAnalisar, sexoPaciente, todosNomesBuscaArray);
            }
            return exame; // Retorna exames que não usam a análise padrão
        });

        examesEncontradosGlobal = todosExames.filter(exame => exame.value !== null && exame.value !== undefined).map(exame => {
            exame.selected = exame.selected !== undefined ? exame.selected : !exame.optional;
            return exame;
        });
        
        renderizarSidebar(examesEncontradosGlobal);
        gerarTextoFinal();
        salvarNoHistorico(); // Salva automaticamente após análise
    }

    function filtrarExames() {
        const termoBusca = filtroExamesInput.value.toLowerCase().trim();
        const termoNormalizado = removerAcentos(termoBusca);
        
        if (!termoBusca) {
            renderizarSidebar(examesEncontradosGlobal); // Se a busca estiver vazia, mostra todos
            return;
        }
        const examesFiltrados = examesEncontradosGlobal.filter(exame => {
            const label = exame.label.toLowerCase();

            // Verifica se o termo de busca está no label curto ou em algum dos nomes de busca (sinônimos)
            return label.includes(termoNormalizado) || 
                   (exame.nomesBusca && exame.nomesBusca.some(nome => removerAcentos(nome.toLowerCase()).includes(termoNormalizado)));
        });
        renderizarSidebar(examesFiltrados);
    }

    function renderizarSidebar(exames) {
        if (!exames || exames.length === 0) {
            listaExamesUl.innerHTML = '<li class="instructions">Nenhum exame conhecido foi encontrado.</li>';
            return;
        }
        listaExamesUl.innerHTML = exames.map(exame => `
            <li>
                <input type="checkbox" id="${exame.id}" data-exame-id="${exame.id}" ${exame.selected ? 'checked' : ''}>
                <label for="${exame.id}">${exame.label}</label>
                <span class="exame-valor ${exame.status === 'alterado' ? 'valor-alterado' : ''}">${exame.value}</span>
            </li>
        `).join('');
    }

    function atualizarSelecao(id, isSelected) {
      const exame = examesEncontradosGlobal.find(e => e.id === id);
      if (exame) {
          exame.selected = isSelected;
          gerarTextoFinal();
      }
    }

    function handleSelecaoExame(event) {
        if (event.target.matches('input[type="checkbox"][data-exame-id]')) {
            atualizarSelecao(event.target.dataset.exameId, event.target.checked);
        }
    }

    function gerarTextoFinal() {
    const dataLaudo = pegarData(inputArea.value);
    const marcarAlterados = marcarAlteradosToggle.checked;
    
    const partesResultado = examesEncontradosGlobal
        .filter(exame => exame.selected)
        .map(exame => {
            const parteOriginal = exame.template(exame.value);
            // Se a opção estiver marcada e o status for 'alterado', adiciona o asterisco
            if (marcarAlterados && exame.status === 'alterado') {
                return parteOriginal.replace(/ \/ $/, '* / ');
            }
            return parteOriginal;
        });

    let resultado = `>> ${dataLaudo ? dataLaudo + ': ' : ''}${partesResultado.join('')}`;
    
    resultado = resultado.trim().replace(/\/$/, '').trim(); // Remove última barra e espaços
    
    resultadoDiv.textContent = resultado.toUpperCase();
    }

    function salvarNoHistorico() {
    // Salvar resultado no histórico
    const texto = inputArea.value;
    const nomePaciente = pegarNomePaciente(texto);
    const dataCompleta = pegarDataCompleta(texto); 
    const resultadoFinal = resultadoDiv.textContent;

    if (dataCompleta && resultadoFinal.length > 10) { // Só salva se tiver data e resultado
        const resultadosRecentes = JSON.parse(localStorage.getItem('resultadosRecentes') || '[]');
        const novoResultado = {
            id: Date.now(), // ID único para ordenação de grupos
            paciente: nomePaciente,
            dataCompleta: dataCompleta,
            resultado: resultadoFinal
        };
        resultadosRecentes.push(novoResultado);
        // Limita o histórico aos últimos 50 resultados para não sobrecarregar
        localStorage.setItem('resultadosRecentes', JSON.stringify(resultadosRecentes.slice(-50)));
        renderizarResultadosRecentes();
    }
    }

    // Funções auxiliares para cópia individual
    function copiarTexto(texto) {
        navigator.clipboard.writeText(texto)
            .then(() => showToast('Resultado copiado!'))
            .catch(() => showToast('Falha ao copiar.'));
    }
  </script>

  <script>
    // Função para baixar o script
    function baixarScript() { 
        // Pega todo o conteúdo HTML da página atual
        const conteudoHtml = document.documentElement.outerHTML;
        // Cria um objeto Blob, que é um objeto semelhante a um arquivo
        const blob = new Blob([conteudoHtml], { type: 'text/html' });
        // Cria uma URL temporária para o Blob
        const url = URL.createObjectURL(blob);

        // Cria um link <a> invisível para iniciar o download
        const a = document.createElement('a');
        a.href = url;
        a.download = 'processador_laudos.html'; // Nome do arquivo que será baixado
        document.body.appendChild(a); // Adiciona o link ao corpo do documento
        a.click(); // Simula o clique no link para iniciar o download
        document.body.removeChild(a); // Remove o link após o clique
        URL.revokeObjectURL(url); // Libera a memória da URL criada
        showToast('Download iniciado!');
    }
  </script>


</body></html>